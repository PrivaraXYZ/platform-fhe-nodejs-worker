services:
  fhe-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - WORKER_MIN_THREADS=${WORKER_MIN_THREADS:-2}
      - WORKER_MAX_THREADS=${WORKER_MAX_THREADS:-4}
      - WORKER_IDLE_TIMEOUT=${WORKER_IDLE_TIMEOUT:-60000}
      - WORKER_MAX_QUEUE=${WORKER_MAX_QUEUE:-100}
      - WORKER_TASK_TIMEOUT=${WORKER_TASK_TIMEOUT:-45000}
      - FHE_CHAIN_ID=${FHE_CHAIN_ID:-11155111}
      - FHE_NETWORK_NAME=${FHE_NETWORK_NAME:-Ethereum Sepolia}
      - FHE_NETWORK_URL=${FHE_NETWORK_URL:-https://eth-sepolia.public.blastapi.io}
      - FHE_GATEWAY_URL=${FHE_GATEWAY_URL:-https://relayer.testnet.zama.org}
      - FHE_ACL_ADDRESS=${FHE_ACL_ADDRESS:-0xf0Ffdc93b7E186bC2f8CB3dAA75D86d1930A433D}
      - FHE_KMS_ADDRESS=${FHE_KMS_ADDRESS:-0xbE0E383937d564D7FF0BC3b46c51f0bF8d5C311A}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
